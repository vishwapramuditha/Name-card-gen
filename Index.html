<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Label Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Fonts: Noto Serif Sinhala for the classic look -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Sinhala:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
        }

        /* --- THE STICKER STYLE --- */
        /* Exact ratio: 3in / 2.5in = 1.2 */
        
        .book-label {
            width: 300px; /* Screen preview width */
            height: 250px; /* Screen preview height */
            background: white;
            /* The Classic Double Border Look */
            border: 1px solid #000;
            outline: 4px solid #000;
            outline-offset: -6px;
            
            position: relative;
            padding: 16px 20px; /* Inner spacing inside the border */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            
            /* Classic Font Stack */
            font-family: 'Tinos', 'Noto Serif Sinhala', serif;
            color: #000;
            overflow: hidden;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15);
        }

        /* Field Labels (Small text like "Name:") */
        .field-label {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            color: #444;
            margin-bottom: 0px;
            line-height: 1;
        }

        /* The Name Field */
        .label-name-container {
            border-bottom: 1px dotted #999; /* The dotted line look */
            padding-bottom: 2px;
            margin-bottom: 10px;
        }
        .label-name {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.1;
            white-space: nowrap;
        }

        /* The Subject (Centerpiece) */
        .label-subject-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: 1px solid #eee; /* Light box around subject */
            background: #fafafa;
            border-radius: 8px;
            margin: 5px 0;
            padding: 5px;
        }
        .label-subject {
            font-size: 26px; /* Big text */
            font-weight: 800;
            line-height: 1;
            text-transform: capitalize;
            z-index: 10;
        }

        /* Bottom Section */
        .bottom-section {
            margin-top: 5px;
            position: relative;
            z-index: 20;
        }

        .label-grade {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .label-school {
            font-size: 11px;
            font-weight: 600;
            font-style: italic;
            max-width: 65%; /* Make room for image */
        }

        /* The Cartoon Image */
        .label-image {
            position: absolute;
            bottom: 15px; /* Pushed up by the outline offset */
            right: 15px;  /* Pushed left by the outline offset */
            width: 75px;
            height: 75px;
            object-fit: contain;
            z-index: 30;
        }

        /* --- STAGING (High Res) --- */
        #staging-area {
            position: fixed;
            top: -10000px;
            left: -10000px;
        }

        .book-label.high-res {
            width: 600px; /* 2x Scale */
            height: 500px;
            outline-width: 8px;
            outline-offset: -12px;
            padding: 32px 40px;
            border-width: 2px;
        }
        .book-label.high-res .field-label { font-size: 20px; }
        .book-label.high-res .label-name-container { border-bottom-width: 2px; margin-bottom: 20px; padding-bottom: 4px; }
        .book-label.high-res .label-name { font-size: 34px; }
        .book-label.high-res .label-subject-container { margin: 15px 0; border-width: 2px; border-radius: 16px; padding: 10px; }
        .book-label.high-res .label-subject { font-size: 56px; }
        .book-label.high-res .bottom-section { margin-top: 10px; }
        .book-label.high-res .label-grade { font-size: 28px; margin-bottom: 8px; }
        .book-label.high-res .label-school { font-size: 22px; max-width: 65%; }
        .book-label.high-res .label-image { width: 150px; height: 150px; bottom: 30px; right: 30px; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                <span class="text-yellow-400 text-2xl">★</span> Label Master
            </h1>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-grow container mx-auto p-4 flex flex-col lg:flex-row gap-8">
        
        <!-- INPUT COLUMN -->
        <div class="w-full lg:w-3/5 space-y-6">
            
            <!-- 1. Student Info -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Student Details</h2>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
                        <input type="text" id="inputName" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none font-serif" placeholder="S.A. Kasun Perera" oninput="updatePreview()">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Grade</label>
                            <input type="text" id="inputGrade" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none font-serif" placeholder="5" oninput="updatePreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Display As</label>
                            <select id="inputGradeLabel" class="w-full p-2 border border-slate-300 rounded bg-white" onchange="updatePreview()">
                                <option value="ශ්‍රේණිය">Sinhala (5 ශ්‍රේණිය)</option>
                                <option value="Grade">English (Grade 5)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">School</label>
                        <input type="text" id="inputSchool" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none font-serif" value="මා/දියදාව කනිෂ්ඨ විද්‍යාලය" oninput="updatePreview()">
                    </div>
                </div>
            </div>

            <!-- 2. Subjects -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <div class="flex justify-between items-end mb-4 border-b pb-2">
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Subjects</h2>
                    <div class="text-xs text-slate-500">Add subjects and quantity for each</div>
                </div>

                <!-- Bulk Paste -->
                <div class="mb-4">
                     <details class="text-xs text-blue-600 cursor-pointer select-none">
                        <summary>Paste list from Excel/Word?</summary>
                        <div class="mt-2 p-2 bg-slate-50 rounded border">
                            <textarea id="bulkPaste" rows="3" class="w-full p-2 border rounded" placeholder="Paste list here..."></textarea>
                            <button onclick="processBulkPaste()" class="mt-2 bg-slate-800 text-white px-3 py-1 rounded">Add Items</button>
                        </div>
                     </details>
                </div>

                <div id="subjectsContainer" class="space-y-2"></div>
                <button onclick="addSubjectRow()" class="mt-3 w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded hover:border-blue-400 hover:text-blue-500 font-semibold">+ Add Another Subject</button>
            </div>

            <!-- 3. Image -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Sticker Image</h2>
                <div class="flex items-center gap-4">
                     <div class="w-16 h-16 bg-slate-100 rounded border flex items-center justify-center overflow-hidden">
                         <img id="thumbImage" src="" class="w-full h-full object-contain">
                     </div>
                     <div>
                         <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                         <button onclick="document.getElementById('imageUpload').click()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900">Change Image</button>
                         <button onclick="resetImage()" class="ml-2 text-sm text-red-500 underline">Reset</button>
                     </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button onclick="generatePDF()" id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-4 rounded-lg shadow-xl transition transform active:scale-95 flex flex-col items-center">
                <span>Download PDF</span>
                <span class="text-xs opacity-80 font-normal">A4 Size • 3" x 2.5" Labels</span>
            </button>
             <div id="statusMsg" class="text-center text-sm font-bold text-blue-600 hidden mt-2 animate-pulse">Generating PDF...</div>

        </div>

        <!-- PREVIEW COLUMN -->
        <div class="w-full lg:w-2/5">
            <div class="sticky top-24">
                <div class="bg-slate-800 text-white p-3 rounded-t-lg flex justify-between items-center">
                    <h2 class="font-bold">Live Preview</h2>
                    <span class="text-xs bg-slate-700 px-2 py-1 rounded">3" x 2.5"</span>
                </div>
                <div class="bg-slate-200 p-8 rounded-b-lg shadow-inner flex justify-center">
                    
                    <!-- THE PREVIEW CARD HTML -->
                    <div id="previewCard" class="book-label">
                        
                        <!-- Name Section -->
                        <div class="label-name-container">
                            <div class="field-label">Name:</div>
                            <div class="label-name" id="previewName">S.A. Kasun Perera</div>
                        </div>

                        <!-- Subject Section -->
                        <div class="label-subject-container">
                            <div class="field-label" style="margin-bottom:2px;">Subject</div>
                            <div class="label-subject" id="previewSubject">Science</div>
                        </div>

                        <!-- Bottom Section -->
                        <div class="bottom-section">
                            <div class="label-grade" id="previewGrade">Grade: 5</div>
                            <div class="label-school" id="previewSchool">මා/දියදාව කනිෂ්ඨ විද්‍යාලය</div>
                        </div>

                        <!-- Image -->
                        <img id="previewImage" src="" class="label-image">
                        
                    </div>
                    <!-- END PREVIEW CARD -->

                </div>
                <p class="text-center text-slate-500 text-xs mt-3">This preview matches the PDF layout exactly.</p>
            </div>
        </div>

    </div>

    <!-- Hidden Staging -->
    <div id="staging-area"></div>

    <script>
        // --- CONFIG ---
        let rowIdCounter = 0;
        // Default "Boy Reading" Icon
        const defaultImage = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNDQ0IiBkPSJNMzg0IDExMmgtNjRjMC0xNy43LTE0LjMtMzItMzItMzJzLTMyIDE0LjMtMzIgMzJIMUMwaC0zMnYzNmgzMnY2NGgtMzJ2MzZoMzJ2NjRoLTMydjM2aDMyYzAgMTcuNyAxNC4zIDMyIDMyIDMyaDEyOGMxNy43IDAgMzItMTQuMyAzMi0zMlYxMTJ6bS05NiAybjMyIDB2MjI0aC0zMlYxMTR6Ii8+PHBhdGggZmlsbD0iIzQyODVGNCIgZD0iTTE5MiA2NGgtNjRjLTE3LjcgMC0zMiAxNC4zLTMyIDMyczE0LjMgMzIgMzIgMzJ2MjI0YzAtMTcuNyAxNC4zLTMyIDMyLTMyczMyIDE0LjMgMzIgMzJWMTEyYzAtMTEuOC02LjUtMjIuMS0xNi4zLTI3LjhsMTYuMy0uMnYyNjhjMCAxNy43IDE0LjMgMzIgMzIgMzJzMzItMTQuMyAzMi0zMlY5NmMwLTE3LjctMTQuMy0zMi0zMi0zMnptLTMyIDUyYzguOCAwIDE2IDcuMiAxNiAxNnMtNy4yIDE2LTE2IDE2LTE2LTcuMi0xNi0xNiA3LjItMTYgMTYtMTZ6Ii8+PC9zdmc+";
        
        let currentImage = defaultImage;
        document.getElementById('previewImage').src = currentImage;
        document.getElementById('thumbImage').src = currentImage;

        // --- INIT ---
        addSubjectRow("Science", 2);
        updatePreview();

        // --- FUNCTIONS ---

        function addSubjectRow(subName = "", count = 1) {
            const container = document.getElementById('subjectsContainer');
            const id = rowIdCounter++;
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = "flex items-center gap-2 animate-fade-in";
            div.innerHTML = `
                <div class="flex-grow">
                    <input type="text" value="${subName}" class="subject-input w-full p-2 border border-slate-300 rounded text-sm font-serif focus:border-blue-500 outline-none" placeholder="Subject (e.g. Maths)" oninput="updatePreviewFromRow(${id})">
                </div>
                <div class="w-20">
                    <input type="number" value="${count}" min="1" class="count-input w-full p-2 border border-slate-300 rounded text-sm text-center font-bold" title="Qty">
                </div>
                <button onclick="document.getElementById('row-${id}').remove()" class="text-slate-400 hover:text-red-500 p-2">✕</button>
            `;
            container.appendChild(div);
            if(container.children.length === 1) updatePreviewFromRow(id);
        }

        function processBulkPaste() {
            const val = document.getElementById('bulkPaste').value;
            if(!val.trim()) return;
            val.split('\n').forEach(l => { if(l.trim()) addSubjectRow(l.trim(), 1); });
            document.getElementById('bulkPaste').value = "";
        }

        function updatePreview() {
            const name = document.getElementById('inputName').value || "";
            const grade = document.getElementById('inputGrade').value || "";
            const gradeLabel = document.getElementById('inputGradeLabel').value;
            const school = document.getElementById('inputSchool').value || "";

            // Logic: D.P.L. Name
            document.getElementById('previewName').innerText = name ? `D.P.L. ${name}` : "";

            // Logic: Grade string
            let gStr = "";
            if(grade) {
                gStr = gradeLabel === "ශ්‍රේණිය" ? `${grade} ${gradeLabel}` : `${gradeLabel} ${grade}`;
            }
            document.getElementById('previewGrade').innerText = gStr;
            document.getElementById('previewSchool').innerText = school;
        }

        function updatePreviewFromRow(id) {
            updatePreview();
            const row = document.getElementById(`row-${id}`);
            if(row) {
                const txt = row.querySelector('.subject-input').value;
                document.getElementById('previewSubject').innerText = txt || "Subject";
            }
        }

        function handleImageUpload(e) {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = (res) => {
                    currentImage = res.target.result;
                    document.getElementById('previewImage').src = currentImage;
                    document.getElementById('thumbImage').src = currentImage;
                };
                r.readAsDataURL(f);
            }
        }
        function resetImage() {
            currentImage = defaultImage;
            document.getElementById('previewImage').src = currentImage;
            document.getElementById('thumbImage').src = currentImage;
            document.getElementById('imageUpload').value = "";
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const name = document.getElementById('inputName').value;
            const school = document.getElementById('inputSchool').value;
            const grade = document.getElementById('inputGrade').value;
            const gradeLabel = document.getElementById('inputGradeLabel').value;
            let gStr = grade ? (gradeLabel === "ශ්‍රේණිය" ? `${grade} ${gradeLabel}` : `${gradeLabel} ${grade}`) : "";
            
            const rows = document.querySelectorAll('#subjectsContainer > div');
            if(rows.length === 0 || !name) { alert("Please enter Name and at least one Subject."); return; }

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('statusMsg');
            const staging = document.getElementById('staging-area');

            btn.disabled = true;
            status.classList.remove('hidden');
            staging.innerHTML = '';

            let total = 0;
            // Create High Res DOM Elements
            rows.forEach(r => {
                const sub = r.querySelector('.subject-input').value.trim();
                const qty = parseInt(r.querySelector('.count-input').value) || 1;
                if(sub) {
                    for(let i=0; i<qty; i++) {
                        const d = document.createElement('div');
                        d.className = 'book-label high-res';
                        d.innerHTML = `
                            <div class="label-name-container">
                                <div class="field-label">Name:</div>
                                <div class="label-name">D.P.L. ${name}</div>
                            </div>
                            <div class="label-subject-container">
                                <div class="field-label" style="margin-bottom:5px;">Subject</div>
                                <div class="label-subject">${sub}</div>
                            </div>
                            <div class="bottom-section">
                                <div class="label-grade">${gStr}</div>
                                <div class="label-school">${school}</div>
                            </div>
                            <img src="${currentImage}" class="label-image">
                        `;
                        staging.appendChild(d);
                        total++;
                    }
                }
            });

            await new Promise(r => setTimeout(r, 600)); // Wait for render

            // PDF Setup
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pw = 210, ph = 297;
            
            // Dimensions: 3in x 2.5in
            const cw = 76.2; // 3 inch
            const ch = 63.5; // 2.5 inch
            
            // Grid: 2 cols, 4 rows = 8 per page
            // Margins to center the block of 2x4
            // Block Width = 152.4mm. Left Margin = (210 - 152.4)/2 = 28.8
            // Block Height = 254mm. Top Margin = (297 - 254)/2 = 21.5
            const mx = 28.8;
            const my = 21.5;

            const cards = staging.querySelectorAll('.book-label');
            let count = 0;

            for(let i=0; i<cards.length; i++) {
                status.innerText = `Generating ${i+1}/${total}...`;
                const cvs = await html2canvas(cards[i], { scale: 2, backgroundColor:'#ffffff' });
                const img = cvs.toDataURL('image/jpeg', 0.95);

                const col = count % 2;
                const row = Math.floor(count / 2);
                const x = mx + (col * cw);
                const y = my + (row * ch);

                pdf.addImage(img, 'JPEG', x, y, cw, ch);
                count++;

                if(count === 8 && i < cards.length-1) {
                    pdf.addPage();
                    count = 0;
                }
            }

            pdf.save(`${name}_Labels.pdf`);
            
            staging.innerHTML = '';
            btn.disabled = false;
            status.classList.add('hidden');
        }
    </script>
</body>
  </html>
